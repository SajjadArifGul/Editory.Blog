@model Editory.Blog.Areas.Dashboard.ViewModels.PostActionViewModel
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-1 text-gray-800">
            @Model.PageTitle
        </h1>
        <p class="mb-4">
            @Model.PageDescription
        </p>
        <hr />
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        @*<div class="form-group">
            <label>
                URL
            </label>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">
                        @Url.BlogPost(123).ToSiteURL()/
                    </span>
                </div>
                <input type="text" class="form-control" id="postURL" name="URL" value="@Model.URL">
            </div>
        </div>*@

        <form id="actionForm" method="post">
            <input type="hidden" name="ID" value="@Model.ID" />

            <div class="form-group">
                <label>
                    Category
                </label>
                <select class="form-control" name="CategoryID">
                    @foreach (var category in Model.Categories.OrderBy(x => x.Name))
                    {
                        var selected = Model.CategoryID == category.ID ? "selected" : string.Empty;
                        <option value="@category.ID" @selected>@category.Name</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label>
                    Title
                </label>
                <input class="form-control" id="postTitle" name="Title" value="@Model.Title" />
            </div>

            <div class="form-group">
                <label>
                    Summary
                </label>
                <textarea class="form-control" id="Summary" name="Summary" placeholder="Add Summary." rows="3">@Model.Summary</textarea>
            </div>

            <div class="form-group">
                <label>
                    Description
                </label>
                <textarea class="form-control" id="Description" name="Description" placeholder="Add Description." rows="10">@Model.Description</textarea>
            </div>


            <div class="form-group">
                <label>
                    Post Pictures
                </label>
                <input id="selectPictures" class="form-control" type="file" multiple />
                <div id="picturesArea" class="row m-0 pb-2">
                </div>
                <input type="hidden" name="PostPictures" id="pictureIDs" />
            </div>

            <hr />
            <div class="form-group">
                @if (Model.ID > 0)
                {
                    <button class="btn btn-success" type="button" id="actionButton">
                        <i class="fas fa-edit mr-1"></i>
                        Update
                    </button>
                    <button class="deleteButton btn btn-danger" type="button" data-id="@Model.ID">
                        <i class="fas fa-trash-alt mr-1"></i>
                        Delete
                    </button>
                }
                else
                {
                    <button class="btn btn-success" type="button" id="actionButton">
                        <i class="fas fa-plus mr-1"></i>
                        Save
                    </button>
                }
                <a class="btn btn-secondary" href="@Url.ListAction("Posts")">
                    <i class="fas fa-angle-double-left mr-1"></i>
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<div id="imageTemplate" style="display:none">
    <div class="card mt-2" style="width:300px;">
        <div class="card-body text-center">
            <img class='image card-img-top img-thumbnail' src='' style="width: 250px; height: 250px;" />
        </div>
        <ul class="list-group list-group-flush">
            <li class="list-group-item">
                <input type="radio" name="ThumbnailPicture" class="mr-1" value=''>
                <label>Set as Thumbnail Image</label>
            </li>
        </ul>
        <div class="card-footer">
            <button type="button" class="btn btn-danger" onclick="removeImage(this)"><i class="fas fa-times mr-1"></i> Remove</button>
        </div>
    </div>
</div>

<script>

    $(document).ready(function () {
        CKEDITOR.replace('Description', { height: 700 });
    });

    $("#postTitle").keyup(function () {
        var titleValue = $(this).val();
        if (titleValue) {
            var sanitizedURL = titleValue.replace(/[^a-zA-Z0-9 ]/g, "").replace(/\s+/g, '-').toLowerCase();
            $("#postURL").val(sanitizedURL);
        }
    });

    $("#actionForm").validate({
        errorClass: "alert alert-danger",
        errorElement: "div",
        rules: {
            Title: {
                required: true,
                minlength: 15
            },
            Summary: {
                minlength: 20,
                maxlength: 200
            },
            Description: {
                required: true,
                minlength: 20
            },
            CategoryID: {
                required: true
            },
            PostPictures: {
                required: true,
            },
        },
        messages: {
            Title: {
                required: "Title is required.",
                minlength: "Minimum Length is 15.",
            },
            Summary: {
                minlength: "Minimum Length is 20.",
                maxlength: "Maximum Length is 200."
            },
            Description: {
                required: "Description is required.",
                minlength: "Minimum Length is 20.",
            },
            CategoryID: {
                required: "Please select a category."
            },
            PostPictures: {
                required: "Please select atleast one picture.",
            },
        },
        highlight: function (element, errorClass) {
            $(element).removeClass(errorClass);
        }
    });

    $("#selectPictures").change(function () {
		var pictures = this.files;

		var picsData = new FormData();

		for (var i = 0; i < pictures.length; i++) {
			picsData.append("Picture", pictures[i]);
		}

		$.ajax({
			url: "@Url.Action("UploadPictures", "Shared", new { area = "" })",
			type: "post",
			data: picsData,
			dateType: "json",
			processData: false,
			contentType: false
		})
		.done(function (responses) {
			for (var i = 0; i < responses.length; i++) {
				var picResponse = responses[i];

				AttachNewImage(picResponse.pictureURL, picResponse.ID);
			}
		});
    });

    function AttachNewImage(imageURL, imageID) {
        var $newimgHTML = $("#imageTemplate").clone();

        $newimgHTML.find(".image").attr("src", "/content/images/" + imageURL);
        $newimgHTML.find(".image").attr("data-id", imageID);
        $newimgHTML.find("input[name=ThumbnailPicture]").val(imageID);

        $("#picturesArea").append($newimgHTML.html());
    }

    $("#actionButton").click(function () {
        updateEditFields();

        var imageIDs = [];
        $("#picturesArea .image").each(function () {
            var imageID = $(this).attr("data-id");

            imageIDs.push(imageID);
        });

        $("#pictureIDs").val(imageIDs.join());

        if ($("#actionForm").valid()) {
            $("#actionForm").submit()
        }
    });

    $(".deleteButton").click(function () {
        var recordID = $(this).attr("data-id");

        swal({
			title: "Are you sure you want to delete this record?",
			icon: "warning",
			buttons: true,
			dangerMode: true,
		})
		.then((willDelete) => {
			if (willDelete) {
				$("#dtLoader").show();
				$("#response-holder").hide();

				$.ajax({
					url: "@Url.DeleteAction("Products")",
                    type: "post",
                    data: { id: recordID }
				})
                .done(function (response) {
                    if (response != null && response.Success != undefined && response.Success) {
                        window.location.href = "@Url.ListAction("Products")";
				    }
				    else {
                        swal("Error!", response.Message, "error");
				    }
				});
			}
		});
    });

</script>